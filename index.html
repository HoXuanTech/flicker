<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>影片抽幀 → A4 PDF（2×5）</title>
<style>
  :root{ --card:#161b2a; --bg:#0f1422; --muted:#93a0ad; --text:#e9eef6; }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(160deg,#0b0e13,#0f1422);color:var(--text);font-family:system-ui,Segoe UI,Roboto,"Noto Sans TC";}
  .wrap{max-width:720px;margin:28px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:16px}
  h1{font-size:22px;margin:0 0 14px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:10px 0}
  label{font-size:13px;color:var(--muted)}
  input[type="number"], input[type="text"]{width:110px;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0e1320;color:var(--text)}
  input[type="file"]{color:var(--text)}
  button{padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:#2563eb;color:#fff;cursor:pointer}
  .hint{font-size:12px;color:var(--muted)}
  .sep{height:1px;background:rgba(255,255,255,.08);margin:14px 0}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
</style>
</head>
<body>
<div class="wrap">
  <h1>匯出 PDF（影片抽幀 → 12:7 裁切 → A4 排版）</h1>
  <div class="card">
    <div class="row">
      <input type="file" id="targetVideo" accept="video/*" />
      <label>← 目標影片</label>
    </div>

    <div class="row">
      <label>抽取張數</label>
      <input type="number" id="frameCount" value="50" min="1" />
      <span class="hint">輸入 40 / 50 / 60 / 80 …，程式會平均分布時間點擷取</span>
    </div>

    <div class="row">
      <label>檔案編碼（直排）</label>
      <input type="text" id="fileCode" value="FILE-ABC-001" />
      <span class="hint">建議用英數（純 jsPDF 預設字型對中文支援有限）</span>
    </div>

    <div class="sep"></div>
    <h3>版面（mm）A4 直式 / 每頁 2 × 5</h3>
    <div class="grid2">
      <div class="row">
        <label>單張寬</label><input type="number" id="imgW" value="96" step="0.1">
        <label>單張高</label><input type="number" id="imgH" value="56" step="0.1">
      </div>
      <div class="row">
        <label>邊界 X</label><input type="number" id="mx" value="11" step="0.1">
        <label>邊界 Y</label><input type="number" id="my" value="7.5" step="0.1">
      </div>
      <div class="row">
        <label>水平間距</label><input type="number" id="sx" value="4" step="0.1">
        <label>垂直間距</label><input type="number" id="sy" value="1" step="0.1">
      </div>
    </div>

    <div class="row">
      <button id="btnMakePDF">輸出 PDF</button>
    </div>

    <div class="hint">
      會依「抽取張數」平均取樣；每張中央裁 12:7、縮 600×350，再依 mm 配置排入 A4；每張右下角印小號編號，左側直排檔案編碼。<br>
      輸出檔名：<em>Output_目標影片名稱.pdf</em>
    </div>
  </div>
</div>

<!-- jsPDF CDN -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>
(() => {
  const targetVideoInput = document.getElementById('targetVideo');
  const frameCountEl = document.getElementById('frameCount');
  const fileCodeEl = document.getElementById('fileCode');

  const imgWEl = document.getElementById('imgW');
  const imgHEl = document.getElementById('imgH');
  const mxEl   = document.getElementById('mx');
  const myEl   = document.getElementById('my');
  const sxEl   = document.getElementById('sx');
  const syEl   = document.getElementById('sy');

  const btnMakePDF = document.getElementById('btnMakePDF');

  // 把影片某時間點擷取成 12:7 中央裁切後的 600x350 圖片（DataURL）
  async function captureAtTime(video, tSec){
    await new Promise(res => {
      // 某些瀏覽器 seek 很快就觸發 onseeked；保守一點用 once
      const handler = () => { video.removeEventListener('seeked', handler); res(); };
      video.addEventListener('seeked', handler, { once: true });
      video.currentTime = Math.min(tSec, video.duration || 0);
    });

    const cap = document.createElement('canvas');
    cap.width = video.videoWidth || 1280;
    cap.height = video.videoHeight || 720;
    const cctx = cap.getContext('2d');
    cctx.drawImage(video, 0, 0, cap.width, cap.height);

    // 中央裁切比例 12:7
    const targetRatio = 12/7;
    const w = cap.width, h = cap.height;
    const tw = Math.min(w, Math.floor(h * targetRatio));
    const th = Math.min(h, Math.floor(w / targetRatio));
    const cx = Math.floor(w/2), cy = Math.floor(h/2);
    const sx = Math.max(0, cx - Math.floor(tw/2));
    const sy = Math.max(0, cy - Math.floor(th/2));

    // 縮放到 600x350
    const out = document.createElement('canvas');
    out.width = 600; out.height = 350;
    const octx = out.getContext('2d');
    octx.drawImage(cap, sx, sy, tw, th, 0, 0, out.width, out.height);

    return out.toDataURL('image/jpeg', 0.9);
  }

  btnMakePDF.addEventListener('click', async () => {
    const file = targetVideoInput.files?.[0];
    if(!file){ alert('請先選擇目標影片'); return; }

    const N = Math.max(1, parseInt(frameCountEl.value || '50', 10));
    const fileCode = (fileCodeEl.value || '').trim();

    const imageWmm = parseFloat(imgWEl.value || '96');
    const imageHmm = parseFloat(imgHEl.value || '56');
    const marginXmm = parseFloat(mxEl.value || '11');
    const marginYmm = parseFloat(myEl.value || '7.5');
    const spacingXmm = parseFloat(sxEl.value || '4');
    const spacingYmm = parseFloat(syEl.value || '1');

    const url = URL.createObjectURL(file);
    const v = document.createElement('video');
    v.src = url; v.preload = 'metadata'; v.muted = true; v.playsInline = true;

    await new Promise(res => { v.onloadedmetadata = res; });

    const duration = v.duration || 0;
    // 均勻取樣時間點（含起點與終點）
    const times = [];
    if (N === 1) {
      times.push(duration/2);
    } else {
      for(let i=0;i<N;i++){
        times.push(i * (duration / (N - 1)));
      }
    }

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({orientation:'p', unit:'mm', format:'a4'});

    const perRow = 2, perCol = 5;
    let placed = 0;

    // 文字樣式
    const codeFontSize = 6;     // 左側直排檔案編碼
    const indexFontSize = 7;    // 右下角小編號
    const pad = 1.5;            // 文字到邊緣的內縮（mm）

    for (let i=0; i<times.length; i++){
      const t = times[i];
      const dataUrl = await captureAtTime(v, t);

      if (placed % (perRow*perCol) === 0) {
        if (placed !== 0) pdf.addPage();
      }
      const idxInPage = placed % (perRow*perCol);
      const col = Math.floor(idxInPage / perCol) % perRow; // 0..1
      const row = idxInPage % perCol;                      // 0..4
      const x = marginXmm + col * (imageWmm + spacingXmm);
      const y = marginYmm + row * (imageHmm + spacingYmm);

      // 放圖片
      pdf.addImage(dataUrl, 'JPEG', x, y, imageWmm, imageHmm);

      // 右下角小編號（1 開始）
      pdf.setFontSize(indexFontSize);
      // jsPDF 無中文字型時請盡量用數字/英字
      const idxText = String(i+1);
      // 右下角定位：對齊右側
      pdf.text(idxText, x + imageWmm - pad, y + imageHmm - pad, { align: 'right' });

      // 左側直排檔案編碼（旋轉 90°）
      if (fileCode){
        pdf.setFontSize(codeFontSize);
        // 以圖左側中線為基準；旋轉 90 度（文字向上）
        const tx = x + pad;                 // 貼近左邊
        const ty = y + imageHmm/2;          // 中線
        pdf.text(fileCode, tx, ty, { angle: 90 });
      }

      placed++;
    }

    const base = (file.name || 'Exported').replace(/\.[^/.]+$/, '');
    pdf.save(`Output_${base}.pdf`);
    URL.revokeObjectURL(url);
    alert('PDF 已輸出完成。');
  });
})();
</script>
</body>
</html>
